<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Satellite Tracker — David Jamieson</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --ink: #0e0e0e; --cream: #f5f0e8; --gold: #c9a84c; --gold-light: #e8d5a3;
    --gold-dim: rgba(201,168,76,0.15); --gold-border: rgba(201,168,76,0.35);
  }

  html, body { width: 100%; height: 100%; overflow: hidden; background: var(--ink); font-family: 'DM Sans', sans-serif; color: #fff; }

  /* ── Globe container ── */
  #globe-container { position: fixed; inset: 0; z-index: 0; }

  /* ── Loading overlay ── */
  #loading-overlay {
    position: fixed; inset: 0; background: var(--ink);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 1000; transition: opacity 0.7s ease;
  }
  #loading-overlay.fade-out { opacity: 0; pointer-events: none; }

  .spinner {
    width: 52px; height: 52px;
    border: 3px solid rgba(201,168,76,0.18);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1.5rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem; font-weight: 700; color: var(--gold);
    margin-bottom: 0.45rem;
  }
  .loading-status {
    font-size: 0.78rem; color: rgba(255,255,255,0.45); margin-bottom: 1.5rem; min-height: 1.2em;
  }
  .progress-bar-wrap {
    width: 220px; height: 2px; background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden;
  }
  .progress-bar {
    height: 100%; background: var(--gold); border-radius: 2px; width: 0%;
    transition: width 0.35s ease;
  }

  /* ── Header ── */
  #header {
    position: fixed; top: 0; left: 0; right: 0;
    padding: 1.25rem 1.75rem;
    display: flex; align-items: center;
    z-index: 100;
    background: linear-gradient(to bottom, rgba(14,14,14,0.82) 0%, transparent 100%);
    pointer-events: none;
  }

  .header-center {
    position: absolute; left: 50%; transform: translateX(-50%); text-align: center;
  }
  .header-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; color: #fff; line-height: 1; }
  .header-subtitle { font-size: 0.62rem; letter-spacing: 0.22em; text-transform: uppercase; color: var(--gold); margin-top: 0.18rem; }

  /* ── Count badge ── */
  #count-badge {
    position: fixed; top: 78px; left: 50%; transform: translateX(-50%);
    background: rgba(14,14,14,0.72); border: 1px solid var(--gold-border);
    color: var(--gold-light); font-size: 0.7rem; letter-spacing: 0.16em; text-transform: uppercase;
    padding: 0.3rem 1rem; border-radius: 100px;
    z-index: 100; white-space: nowrap;
    backdrop-filter: blur(8px);
    opacity: 0; transition: opacity 0.5s ease;
  }
  #count-badge.visible { opacity: 1; }

  /* ── Satellite dots ── */
  .sat-dot {
    width: 4px; height: 4px; border-radius: 50%;
    pointer-events: none; user-select: none;
  }
  .sat-dot.kuiper   { background: #cc00ff; box-shadow: 0 0 5px 2px rgba(204,0,255,0.45); }
  .sat-dot.starlink { background: #00d4ff; box-shadow: 0 0 5px 2px rgba(0,212,255,0.45); border-radius: 0; }

  /* ── Toggle panel — fixed top-right ── */
  #toggle-panel {
    position: fixed; top: 5.5rem; right: 1.75rem;
    display: flex; flex-direction: column; gap: 0.5rem;
    z-index: 100; opacity: 0; transition: opacity 0.5s ease;
  }
  #toggle-panel.visible { opacity: 1; }

  .toggle-btn {
    display: flex; align-items: center; gap: 0.5rem;
    background: rgba(14,14,14,0.82); border: 1px solid rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.5); font-size: 0.68rem; font-family: monospace;
    letter-spacing: 0.1em; text-transform: uppercase;
    padding: 0.35rem 0.85rem; border-radius: 100px;
    cursor: pointer; backdrop-filter: blur(8px);
    transition: border-color 0.2s, color 0.2s; outline: none;
  }
  .toggle-btn.kuiper.active   { border-color: rgba(204,0,255,0.4);   color: rgba(255,255,255,0.85); }
  .toggle-btn.starlink.active { border-color: rgba(0,212,255,0.4);    color: rgba(255,255,255,0.85); }
  .toggle-btn .dot {
    width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
    transition: opacity 0.2s, box-shadow 0.2s;
  }
  .toggle-btn.kuiper .dot   { background: #cc00ff; box-shadow: 0 0 5px 2px rgba(204,0,255,0.5); }
  .toggle-btn.starlink .dot { background: #00d4ff; box-shadow: 0 0 5px 2px rgba(0,212,255,0.5); border-radius: 0; }
  .toggle-btn:not(.active) .dot { opacity: 0.25; box-shadow: none; }

  /* ── Left column (milestone + launches stacked) ── */
  #left-column {
    position: fixed; top: 5.5rem; left: 1.75rem;
    display: flex; flex-direction: column; gap: 0.5rem;
    z-index: 100; opacity: 0; transition: opacity 0.5s ease;
    max-height: calc(100vh - 6rem);
  }
  #left-column.visible { opacity: 1; }

  /* ── FCC Milestone panel ── */
  #milestone-panel {
    background: rgba(14,14,14,0.88); border: 1px solid var(--gold-border);
    border-radius: 6px; padding: 0.75rem 1rem;
    min-width: 280px; backdrop-filter: blur(12px);
  }
  .ms-title { font-size: 0.6rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.65rem; }
  .ms-row { margin-bottom: 0.6rem; }
  .ms-row:last-child { margin-bottom: 0; }
  .ms-label { display: flex; justify-content: space-between; font-size: 0.65rem; font-family: monospace; color: rgba(255,255,255,0.4); margin-bottom: 0.25rem; }
  .ms-label .ms-count { color: rgba(255,255,255,0.75); }
  .ms-bar-wrap { height: 2px; background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden; margin-bottom: 0.2rem; }
  .ms-bar { height: 100%; background: var(--gold); border-radius: 2px; transition: width 0.6s ease; }
  .ms-deadline { font-size: 0.58rem; color: rgba(255,255,255,0.28); }

  /* ── Launch table ── */
  #launch-table {
    background: rgba(14,14,14,0.88); border: 1px solid var(--gold-border);
    border-radius: 6px; padding: 0.75rem 1rem;
    min-width: 280px; backdrop-filter: blur(12px);
    overflow-y: auto; flex-shrink: 1; min-height: 0;
  }
  .lt-title {
    font-size: 0.6rem; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 0.5rem;
  }
  .lt-head, .lt-row {
    display: grid;
    grid-template-columns: 6.5rem 1fr 2rem;
    gap: 0.6rem;
    font-size: 0.67rem; font-family: monospace;
    padding: 0.12rem 0;
  }
  .lt-head {
    font-size: 0.58rem; letter-spacing: 0.08em; text-transform: uppercase;
    color: rgba(255,255,255,0.25);
    border-bottom: 1px solid rgba(255,255,255,0.07);
    padding-bottom: 0.35rem; margin-bottom: 0.15rem;
  }
  .lt-row { color: rgba(255,255,255,0.45); }
  .lt-row span:last-child { color: var(--gold-light); text-align: right; }
  .lt-row .lt-rocket { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .lt-total {
    display: grid;
    grid-template-columns: 6.5rem 1fr 2rem;
    gap: 0.6rem;
    font-size: 0.67rem; font-family: monospace;
    padding: 0.35rem 0 0.12rem;
    margin-top: 0.2rem;
    border-top: 1px solid rgba(255,255,255,0.07);
    color: rgba(255,255,255,0.3);
  }
  .lt-total span:last-child { color: var(--gold); text-align: right; }

  /* ── Mobile tweaks ── */
  @media (max-width: 600px) {
    .header-center { display: none; }
    #left-column { display: none; }
  }
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-title">Satellite Tracker</div>
  <div class="loading-status" id="loading-status">Initialising…</div>
  <div class="progress-bar-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
</div>

<!-- Globe (full-screen) -->
<div id="globe-container"></div>

<!-- Header -->
<div id="header">
  <div class="header-center">
    <div class="header-title">Amazon Leo Satellite Tracker</div>
    <div class="header-subtitle">Project Kuiper — live orbital positions</div>
  </div>
</div>

<!-- Count badge -->
<div id="count-badge">Loading…</div>

<!-- Toggle panel -->
<div id="toggle-panel">
  <button id="toggle-kuiper"   class="toggle-btn kuiper active"><span class="dot"></span>Kuiper</button>
  <button id="toggle-starlink" class="toggle-btn starlink"><span class="dot"></span>Starlink</button>
</div>

<!-- Left column: milestone tracker + launch table -->
<div id="left-column">
  <div id="milestone-panel">
    <div class="ms-title">FCC Milestones — Kuiper</div>
    <div id="ms-rows"></div>
  </div>
  <div id="launch-table">
    <div class="lt-title">Kuiper Launches</div>
    <div class="lt-head"><span>Date</span><span>Rocket</span><span>Sats</span></div>
    <div id="lt-body"></div>
  </div>
</div>

<!-- ── Libraries ── -->
<script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
<script type="module">
// ═══════════════════════════════════════════════════════
//  LIVE SATELLITE TRACKER — djamies1.github.io
// ═══════════════════════════════════════════════════════

import * as satellite from 'https://esm.sh/satellite.js';
import { feature as topoFeature } from 'https://esm.sh/topojson-client';

const EARTH_RADIUS_KM    = 6371;
const KUIPER_CACHE_KEY   = 'satTracker_kuiper_v2';
const STARLINK_CACHE_KEY = 'satTracker_starlink_v2';
const CACHE_TTL_MS       = 15 * 60 * 1000;
// Coverage footprint: ~600 km altitude, 25° minimum elevation angle → 9.1° Earth central angle
const COVERAGE_RADIUS_DEG = 9.1;
const FCC_MILESTONES = [
  { label: 'Phase 1', target:  578, deadline: new Date('2026-07-30'), deadlineStr: 'Jul 2026' },
  { label: 'Phase 2', target: 1156, deadline: new Date('2027-07-30'), deadlineStr: 'Jul 2027' },
  { label: 'Full',    target: 3236, deadline: new Date('2029-07-30'), deadlineStr: 'Jul 2029' },
];

function makeFetchUrls(group) {
  const base = `https://celestrak.org/NORAD/elements/gp.php?GROUP=${group}&FORMAT=TLE`;
  return [
    base,
    'https://corsproxy.io/?' + base,
    'https://api.allorigins.win/raw?url=' + encodeURIComponent(base)
  ];
}

// ── DOM refs ─────────────────────────────────────────────────────────────────
const statusEl   = document.getElementById('loading-status');
const progressEl = document.getElementById('progress-bar');
const overlay    = document.getElementById('loading-overlay');
const countBadge = document.getElementById('count-badge');

// ── Helpers ──────────────────────────────────────────────────────────────────
function setStatus(msg)   { statusEl.textContent = msg; }
function setProgress(pct) { progressEl.style.width = pct + '%'; }

function dismissOverlay() {
  overlay.classList.add('fade-out');
  setTimeout(() => { overlay.style.display = 'none'; }, 750);
  countBadge.classList.add('visible');
  document.getElementById('left-column').classList.add('visible');
  document.getElementById('toggle-panel').classList.add('visible');
}

// ── State ────────────────────────────────────────────────────────────────────
let globe;
let kuiperData   = [];
let starlinkData = [];
let showKuiper   = true;
let showStarlink = false;
let countriesCache = null;

function visibleData() {
  return [...(showKuiper ? kuiperData : []), ...(showStarlink ? starlinkData : [])];
}

function updateGlobeData() {
  if (globe) globe.htmlElementsData(visibleData());
}

function updateCountBadge() {
  const parts = [];
  if (showKuiper && kuiperData.length)     parts.push(kuiperData.length.toLocaleString() + ' Kuiper');
  if (showStarlink && starlinkData.length) parts.push(starlinkData.length.toLocaleString() + ' Starlink');
  if (!parts.length) {
    // Both hidden — show totals dimmed
    const total = (kuiperData.length + starlinkData.length).toLocaleString();
    countBadge.textContent = total + ' satellites (hidden)';
  } else {
    countBadge.textContent = parts.join(' · ') + ' satellites tracked';
  }
}

// ── Coverage footprint helpers ────────────────────────────────────────────────
// Generates a GeoJSON polygon circle using proper spherical geometry
function coverageCircle(lat, lng, radiusDeg = COVERAGE_RADIUS_DEG, n = 32) {
  const D2R = Math.PI / 180;
  const R2D = 180 / Math.PI;
  const angDist = radiusDeg * D2R;
  const lat1 = lat * D2R;
  const lng1 = lng * D2R;
  const coords = [];
  for (let i = 0; i < n; i++) {
    const bearing = (2 * Math.PI * i) / n;
    const lat2 = Math.asin(
      Math.sin(lat1) * Math.cos(angDist) +
      Math.cos(lat1) * Math.sin(angDist) * Math.cos(bearing)
    );
    const lng2 = lng1 + Math.atan2(
      Math.sin(bearing) * Math.sin(angDist) * Math.cos(lat1),
      Math.cos(angDist) - Math.sin(lat1) * Math.sin(lat2)
    );
    coords.push([lng2 * R2D, lat2 * R2D]);
  }
  coords.push(coords[0]); // close ring
  return { type: 'Feature', properties: { type: 'coverage' }, geometry: { type: 'Polygon', coordinates: [coords] } };
}

function updateCoveragePolygons() {
  if (!globe || !countriesCache) return;
  const circles = showKuiper
    ? kuiperData.filter(d => !isNaN(d.lat)).map(d => coverageCircle(d.lat, d.lng))
    : [];
  globe.polygonsData([...countriesCache.features, ...circles]);
}

// ── FCC milestone tracker ─────────────────────────────────────────────────────
function updateMilestonePanel() {
  const count = kuiperData.length;
  const today = new Date();
  const html = FCC_MILESTONES.map(m => {
    const pct      = Math.min(100, (count / m.target) * 100).toFixed(1);
    const daysLeft = Math.ceil((m.deadline - today) / 86400000);
    const daysStr  = daysLeft > 0
      ? daysLeft.toLocaleString() + ' days remaining'
      : 'Deadline passed';
    return `<div class="ms-row">
      <div class="ms-label">
        <span>${m.label} — ${m.deadlineStr}</span>
        <span class="ms-count">${count.toLocaleString()} / ${m.target.toLocaleString()}</span>
      </div>
      <div class="ms-bar-wrap"><div class="ms-bar" style="width:${pct}%"></div></div>
      <div class="ms-deadline">${daysStr}</div>
    </div>`;
  }).join('');
  document.getElementById('ms-rows').innerHTML = html;
}

// ── Launch metadata ───────────────────────────────────────────────────────────
const ll2Promise = (async () => {
  const today = new Date().toISOString().slice(0, 10);
  const searches = ['amazon+leo', 'atlas+v+amazon'];
  for (const q of searches) {
    try {
      const ctrl = new AbortController();
      const tid  = setTimeout(() => ctrl.abort(), 15000);
      const r = await fetch(
        `https://ll.thespacedevs.com/2.2.0/launch/?search=${q}&limit=100&ordering=net`,
        { signal: ctrl.signal }
      );
      clearTimeout(tid);
      if (!r.ok) { console.warn('LL2 HTTP', r.status, 'for', q); continue; }
      const data = await r.json();
      const results = (data.results || [])
        .map(l => ({ date: (l.net || '').slice(0, 10), rocket: l.rocket?.configuration?.name || '—', name: l.name || '' }))
        .filter(l => l.date && l.date <= today)
        .sort((a, b) => a.date.localeCompare(b.date));
      console.log('LL2 results (' + q + '):', results);
      if (results.length) return results;
    } catch (e) {
      console.warn('LL2 error (' + q + '):', e.message);
    }
  }
  return [];
})();

// ── Country data ──────────────────────────────────────────────────────────────
const countryDataPromise = (async () => {
  const [topoResp, countriesResp] = await Promise.all([
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json'),
    fetch('https://restcountries.com/v3.1/all?fields=name,latlng,area')
  ]);
  const [topoData, countryInfo] = await Promise.all([topoResp.json(), countriesResp.json()]);
  const polygons = topoFeature(topoData, topoData.objects.countries);
  const labels = countryInfo
    .filter(c => c.area > 100000 && c.latlng?.length === 2)
    .map(c => ({ lat: c.latlng[0], lng: c.latlng[1], text: c.name.common }));
  return { polygons, labels };
})();

// ── Launch table (Kuiper only) ────────────────────────────────────────────────
function buildLaunchTable() {
  const counts = {};
  kuiperData.forEach(d => { counts[d.launchId] = (counts[d.launchId] || 0) + 1; });

  const sortedIds = Object.keys(counts).filter(id => id !== '—').sort();

  const render = ll2List => {
    const tleYears = new Set(sortedIds.map(id => id.slice(0, 4)));
    const matchLL2 = ll2List.filter(l => l.date && tleYears.has(l.date.slice(0, 4)));

    const rows = sortedIds.map((id, idx) => {
      const ll2    = matchLL2[idx];
      const date   = ll2?.date   || id;
      const rocket = ll2?.rocket || '—';
      return `<div class="lt-row">
        <span>${date}</span>
        <span class="lt-rocket">${rocket}</span>
        <span>${counts[id]}</span>
      </div>`;
    }).join('');
    const total = sortedIds.reduce((sum, id) => sum + counts[id], 0);
    const totalRow = `<div class="lt-total"><span>Total</span><span></span><span>${total}</span></div>`;
    document.getElementById('lt-body').innerHTML = rows + totalRow;
  };

  render([]);
  ll2Promise.then(ll2List => render(ll2List));
}

// ── Fetch with sessionStorage cache ──────────────────────────────────────────
async function fetchWithCache(cacheKey, urls) {
  try {
    const cached = sessionStorage.getItem(cacheKey);
    if (cached) {
      const { text, ts } = JSON.parse(cached);
      if (Date.now() - ts < CACHE_TTL_MS) { return text; }
    }
  } catch (_) {}

  let lastErr;
  for (let i = 0; i < urls.length; i++) {
    try {
      const ctrl = new AbortController();
      const tid  = setTimeout(() => ctrl.abort(), 25000);
      const resp = await fetch(urls[i], { signal: ctrl.signal });
      clearTimeout(tid);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const text = await resp.text();
      if (!text.includes('1 ') || text.length < 100) throw new Error('Response does not look like TLE data');
      try { sessionStorage.setItem(cacheKey, JSON.stringify({ text, ts: Date.now() })); } catch (_) {}
      return text;
    } catch (e) {
      console.warn('Fetch attempt', i + 1, 'failed for', cacheKey, ':', e.message);
      lastErr = e;
    }
  }
  throw lastErr;
}

// ── Parse TLE text ────────────────────────────────────────────────────────────
function parseTLE(rawText, constellation) {
  const chunks = rawText.replace(/\r/g, '').split(/\n(?=[^12\s])/).filter(c => c.trim());
  const now    = new Date();
  const parsed = [];

  for (const chunk of chunks) {
    const parts = chunk.split('\n').map(l => l.trim()).filter(Boolean);
    if (parts.length < 3) continue;
    const [nameLine, line1, line2] = parts;
    if (!line1.startsWith('1 ') || !line2.startsWith('2 ')) continue;

    try {
      const satrec = satellite.twoline2satrec(line1, line2);
      if (!satrec || satrec.error !== 0) continue;
      if (!satellite.propagate(satrec, now)?.position) continue;

      const yr2       = line1.substring(9, 11).trim();
      const launchNum = line1.substring(11, 14).trim();
      const year      = yr2 ? (parseInt(yr2) > 56 ? 1900 : 2000) + parseInt(yr2) : null;
      const launchId  = year && launchNum ? `${year}-${launchNum.padStart(3, '0')}` : '—';

      parsed.push({ satrec, name: nameLine.replace(/^0 /, '').trim(), launchId, constellation });
    } catch (_) {}
  }
  return parsed;
}

// ── Load satellite data ───────────────────────────────────────────────────────
async function loadSatelliteData() {
  setStatus('Connecting to CelesTrak…');
  setProgress(5);

  const [kuiperResult, starlinkResult] = await Promise.allSettled([
    fetchWithCache(KUIPER_CACHE_KEY,   makeFetchUrls('kuiper')),
    fetchWithCache(STARLINK_CACHE_KEY, makeFetchUrls('starlink'))
  ]);

  setStatus('Parsing TLE data…');
  setProgress(42);

  if (kuiperResult.status === 'fulfilled') {
    kuiperData = parseTLE(kuiperResult.value, 'kuiper');
    console.log('Kuiper satellites:', kuiperData.length);
  } else {
    console.error('Kuiper fetch failed:', kuiperResult.reason);
  }

  if (starlinkResult.status === 'fulfilled') {
    starlinkData = parseTLE(starlinkResult.value, 'starlink');
    console.log('Starlink satellites:', starlinkData.length);
  } else {
    console.error('Starlink fetch failed:', starlinkResult.reason);
  }

  if (!kuiperData.length && !starlinkData.length) {
    setStatus('⚠ Network error — please refresh to retry.');
    return;
  }

  buildLaunchTable();
  updateMilestonePanel();

  setStatus(
    'Loaded ' + kuiperData.length.toLocaleString() + ' Kuiper · ' +
    starlinkData.length.toLocaleString() + ' Starlink'
  );
  setProgress(72);
  initGlobe();
}

// ── WebGL detection ───────────────────────────────────────────────────────────
function isWebGLAvailable() {
  try {
    const c = document.createElement('canvas');
    return !!(c.getContext('webgl') || c.getContext('experimental-webgl'));
  } catch (_) { return false; }
}

// ── 2D canvas fallback (no WebGL required) ────────────────────────────────────
function initFallback2D() {
  setStatus('2D mode — WebGL unavailable');
  setProgress(84);

  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:fixed;inset:0;';
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  document.getElementById('globe-container').appendChild(canvas);
  const ctx = canvas.getContext('2d');

  window.addEventListener('resize', () => {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  });

  let countryFeatures = [];
  countryDataPromise.then(({ polygons }) => { countryFeatures = polygons.features; }).catch(() => {});

  function project(lng, lat) {
    return [(lng + 180) / 360 * canvas.width, (90 - lat) / 180 * canvas.height];
  }

  function drawGeo(f) {
    const drawRings = rings => rings.forEach(ring => {
      ring.forEach(([lng, lat], i) => { const [x, y] = project(lng, lat); i ? ctx.lineTo(x, y) : ctx.moveTo(x, y); });
      ctx.closePath();
    });
    ctx.beginPath();
    if (f.geometry.type === 'Polygon') drawRings(f.geometry.coordinates);
    else if (f.geometry.type === 'MultiPolygon') f.geometry.coordinates.forEach(drawRings);
    ctx.stroke();
  }

  function draw2D() {
    ctx.fillStyle = '#0e0e0e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = 'rgba(201,168,76,0.25)';
    ctx.lineWidth = 0.5;
    countryFeatures.forEach(drawGeo);

    if (showKuiper) {
      ctx.shadowColor = 'rgba(204,0,255,0.6)';
      ctx.shadowBlur  = 4;
      ctx.fillStyle   = '#cc00ff';
      kuiperData.forEach(d => {
        if (isNaN(d.lat)) return;
        const [x, y] = project(d.lng, d.lat);
        ctx.fillRect(x - 1.5, y - 1.5, 3, 3);
      });
    }

    if (showStarlink) {
      ctx.shadowColor = 'rgba(0,212,255,0.6)';
      ctx.shadowBlur  = 4;
      ctx.fillStyle   = '#00d4ff';
      starlinkData.forEach(d => {
        if (isNaN(d.lat)) return;
        const [x, y] = project(d.lng, d.lat);
        ctx.fillRect(x - 1.5, y - 1.5, 3, 3);
      });
    }

    ctx.shadowBlur = 0;
  }

  updateCountBadge();
  setProgress(94);
  setStatus('Starting…');
  setTimeout(() => {
    setProgress(100);
    setTimeout(() => {
      dismissOverlay();
      (function frame() { requestAnimationFrame(frame); updatePositions(); draw2D(); })();
    }, 300);
  }, 500);
}

// ── Globe initialisation ──────────────────────────────────────────────────────
function initGlobe() {
  if (!isWebGLAvailable()) { initFallback2D(); return; }

  setStatus('Initialising globe…');
  setProgress(84);

  updatePositions();

  globe = new Globe(document.getElementById('globe-container'))
    .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-dark.jpg')
    .atmosphereColor('#8750ff')
    .backgroundColor('rgba(14,14,14,1)')
    .htmlElementsData(visibleData())
    .htmlLat('lat')
    .htmlLng('lng')
    .htmlAltitude('alt')
    .htmlElement(d => {
      const el = document.createElement('div');
      el.className = `sat-dot ${d.constellation}`;
      return el;
    });

  setTimeout(() => globe.pointOfView({ altitude: 3.5 }));

  updateCountBadge();
  window.addEventListener('resize', () => globe.width(window.innerWidth).height(window.innerHeight));

  countryDataPromise.then(({ polygons, labels }) => {
    countriesCache = polygons;
    globe
      .polygonCapColor(f => f.properties?.type === 'coverage' ? 'rgba(204,0,255,0.05)' : 'rgba(0,0,0,0)')
      .polygonSideColor(() => 'rgba(0,0,0,0)')
      .polygonStrokeColor(f => f.properties?.type === 'coverage' ? 'rgba(204,0,255,0.22)' : 'rgba(201,168,76,0.35)')
      .polygonAltitude(f => f.properties?.type === 'coverage' ? 0 : 0.001)
      .labelsData(labels)
      .labelLat('lat')
      .labelLng('lng')
      .labelText('text')
      .labelAltitude(0.01)
      .labelSize(0.6)
      .labelDotRadius(0)
      .labelColor(() => 'rgba(180,180,180,0.6)')
      .labelResolution(3);
    updateCoveragePolygons();
    setInterval(updateCoveragePolygons, 15000);
  }).catch(e => console.warn('Country overlay failed:', e));

  setProgress(94);
  setStatus('Starting…');
  setTimeout(() => { setProgress(100); setTimeout(() => { dismissOverlay(); startAnimationLoop(); }, 300); }, 500);
}

// ── Position update ───────────────────────────────────────────────────────────
function updatePositions() {
  const now  = new Date();
  const gmst = satellite.gstime(now);
  [...kuiperData, ...starlinkData].forEach(d => {
    const eci = satellite.propagate(d.satrec, now);
    if (eci?.position) {
      const geo = satellite.eciToGeodetic(eci.position, gmst);
      d.lat   = satellite.radiansToDegrees(geo.latitude);
      d.lng   = satellite.radiansToDegrees(geo.longitude);
      d.alt   = geo.height / EARTH_RADIUS_KM;
      d.altKm = Math.round(geo.height);
    } else {
      d.lat = NaN;
    }
  });
}

// ── Animation loop ────────────────────────────────────────────────────────────
function startAnimationLoop() {
  (function frame() {
    requestAnimationFrame(frame);
    updatePositions();
  })();
}

// ── Toggle buttons ────────────────────────────────────────────────────────────
document.getElementById('toggle-kuiper').addEventListener('click', () => {
  showKuiper = !showKuiper;
  document.getElementById('toggle-kuiper').classList.toggle('active', showKuiper);
  updateGlobeData();
  updateCountBadge();
  updateCoveragePolygons();
});

document.getElementById('toggle-starlink').addEventListener('click', () => {
  showStarlink = !showStarlink;
  document.getElementById('toggle-starlink').classList.toggle('active', showStarlink);
  updateGlobeData();
  updateCountBadge();
});


loadSatelliteData();
</script>

</body>
</html>
