<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Satellite Tracker â€” David Jamieson</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --ink: #0e0e0e; --cream: #f5f0e8; --gold: #c9a84c; --gold-light: #e8d5a3;
    --gold-dim: rgba(201,168,76,0.15); --gold-border: rgba(201,168,76,0.35);
  }

  html, body { width: 100%; height: 100%; overflow: hidden; background: var(--ink); font-family: 'DM Sans', sans-serif; color: #fff; }

  /* â”€â”€ Globe container â”€â”€ */
  #globe-container { position: fixed; inset: 0; z-index: 0; }

  /* â”€â”€ Loading overlay â”€â”€ */
  #loading-overlay {
    position: fixed; inset: 0; background: var(--ink);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 1000; transition: opacity 0.7s ease;
  }
  #loading-overlay.fade-out { opacity: 0; pointer-events: none; }

  .spinner {
    width: 52px; height: 52px;
    border: 3px solid rgba(201,168,76,0.18);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1.5rem;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.5rem; font-weight: 700; color: var(--gold);
    margin-bottom: 0.45rem;
  }
  .loading-status {
    font-size: 0.78rem; color: rgba(255,255,255,0.45); margin-bottom: 1.5rem; min-height: 1.2em;
  }
  .progress-bar-wrap {
    width: 220px; height: 2px; background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden;
  }
  .progress-bar {
    height: 100%; background: var(--gold); border-radius: 2px; width: 0%;
    transition: width 0.35s ease;
  }

  /* â”€â”€ Header â”€â”€ */
  #header {
    position: fixed; top: 0; left: 0; right: 0;
    padding: 1.25rem 1.75rem;
    display: flex; align-items: center;
    z-index: 100;
    background: linear-gradient(to bottom, rgba(14,14,14,0.82) 0%, transparent 100%);
    pointer-events: none;
  }

  .header-center {
    position: absolute; left: 50%; transform: translateX(-50%); text-align: center;
  }
  .header-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; color: #fff; line-height: 1; }
  .header-subtitle { font-size: 0.62rem; letter-spacing: 0.22em; text-transform: uppercase; color: var(--gold); margin-top: 0.18rem; }

  /* â”€â”€ Count badge â”€â”€ */
  #count-badge {
    position: fixed; top: 78px; left: 50%; transform: translateX(-50%);
    background: rgba(14,14,14,0.72); border: 1px solid var(--gold-border);
    color: var(--gold-light); font-size: 0.7rem; letter-spacing: 0.16em; text-transform: uppercase;
    padding: 0.3rem 1rem; border-radius: 100px;
    z-index: 100; white-space: nowrap;
    backdrop-filter: blur(8px);
    opacity: 0; transition: opacity 0.5s ease;
  }
  #count-badge.visible { opacity: 1; }

  /* â”€â”€ Launch table â”€â”€ */
  #launch-table {
    position: fixed; top: 5.5rem; left: 1.75rem;
    background: rgba(14,14,14,0.88); border: 1px solid var(--gold-border);
    border-radius: 6px; padding: 0.75rem 1rem;
    z-index: 100; min-width: 170px;
    backdrop-filter: blur(12px);
    max-height: calc(100vh - 8rem); overflow-y: auto;
    opacity: 0; transition: opacity 0.5s ease;
  }
  #launch-table.visible { opacity: 1; }
  .lt-title {
    font-size: 0.6rem; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 0.5rem;
  }
  .lt-row {
    display: flex; justify-content: space-between; gap: 1.5rem;
    font-size: 0.67rem; font-family: monospace;
    color: rgba(255,255,255,0.45); padding: 0.12rem 0;
  }
  .lt-row span:last-child { color: var(--gold-light); }

  /* â”€â”€ Mobile tweaks â”€â”€ */
  @media (max-width: 600px) {
    .header-center { display: none; }
  }
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-title">Satellite Tracker</div>
  <div class="loading-status" id="loading-status">Initialisingâ€¦</div>
  <div class="progress-bar-wrap">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
</div>

<!-- Globe (full-screen) -->
<div id="globe-container"></div>

<!-- Header -->
<div id="header">
  <div class="header-center">
    <div class="header-title">Amazon Leo Satellite Tracker</div>
    <div class="header-subtitle">Project Kuiper â€” live orbital positions</div>
  </div>
</div>

<!-- Count badge -->
<div id="count-badge">Loadingâ€¦</div>

<!-- Launch table -->
<div id="launch-table">
  <div class="lt-title">Launches</div>
  <div id="lt-body"></div>
</div>

<!-- â”€â”€ Libraries â”€â”€ -->
<script src="https://cdn.jsdelivr.net/npm/globe.gl"></script>
<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIVE SATELLITE TRACKER â€” djamies1.github.io
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import * as satellite from 'https://esm.sh/satellite.js';
import { feature as topoFeature } from 'https://esm.sh/topojson-client';

const EARTH_RADIUS_KM = 6371;
const CACHE_KEY = 'satTracker_kuiper_v1';
const CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

// Kuiper-only TLE feed
const CELESTRAK_URL = 'https://celestrak.org/NORAD/elements/gp.php?GROUP=kuiper&FORMAT=TLE';
const FETCH_URLS = [
  CELESTRAK_URL,
  'https://corsproxy.io/?' + CELESTRAK_URL,
  'https://api.allorigins.win/raw?url=' + encodeURIComponent(CELESTRAK_URL)
];

// â”€â”€ Orbit classification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classifyOrbit(altKm) {
  if (altKm < 2000)  return { band: 'LEO', color: '#cc00ff' };
  if (altKm < 35000) return { band: 'MEO', color: '#cc00ff' };
  if (altKm < 36500) return { band: 'GEO', color: '#cc00ff' };
  return { band: 'HEO', color: '#cc00ff' };
}

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const statusEl   = document.getElementById('loading-status');
const progressEl = document.getElementById('progress-bar');
const overlay    = document.getElementById('loading-overlay');
const countBadge = document.getElementById('count-badge');

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg)   { statusEl.textContent = msg; }
function setProgress(pct) { progressEl.style.width = pct + '%'; }

function dismissOverlay() {
  overlay.classList.add('fade-out');
  setTimeout(() => { overlay.style.display = 'none'; }, 750);
  countBadge.classList.add('visible');
  document.getElementById('launch-table').classList.add('visible');
}

function buildLaunchTable() {
  const counts = {};
  satData.forEach(d => { counts[d.launchId] = (counts[d.launchId] || 0) + 1; });
  const rows = Object.entries(counts)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([id, n]) => `<div class="lt-row"><span>${id}</span><span>${n}</span></div>`)
    .join('');
  document.getElementById('lt-body').innerHTML = rows;
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let globe;
let satData = []; // { satrec, name, launch, lat, lng, alt, band, color, altKm }

// â”€â”€ Country data â€” fetched in parallel with satellite data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const countryDataPromise = (async () => {
  const [topoResp, countriesResp] = await Promise.all([
    fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json'),
    fetch('https://restcountries.com/v3.1/all?fields=name,latlng,area')
  ]);
  const [topoData, countryInfo] = await Promise.all([topoResp.json(), countriesResp.json()]);
  const polygons = topoFeature(topoData, topoData.objects.countries);
  const labels = countryInfo
    .filter(c => c.area > 100000 && c.latlng?.length === 2)
    .map(c => ({ lat: c.latlng[0], lng: c.latlng[1], text: c.name.common }));
  return { polygons, labels };
})();

// â”€â”€ Fetch with sessionStorage cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWithCache() {
  try {
    const cached = sessionStorage.getItem(CACHE_KEY);
    if (cached) {
      const { text, ts } = JSON.parse(cached);
      if (Date.now() - ts < CACHE_TTL_MS) { setStatus('Loading from cacheâ€¦'); return text; }
    }
  } catch (_) {}

  let lastErr;
  for (let i = 0; i < FETCH_URLS.length; i++) {
    setStatus(i === 0 ? 'Fetching from CelesTrakâ€¦' : i === 1 ? 'Trying proxy fallbackâ€¦' : 'Trying secondary fallbackâ€¦');
    setProgress(10 + i * 15);
    try {
      const ctrl = new AbortController();
      const tid  = setTimeout(() => ctrl.abort(), 25000);
      const resp = await fetch(FETCH_URLS[i], { signal: ctrl.signal });
      clearTimeout(tid);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const text = await resp.text();
      if (!text.includes('1 ') || text.length < 100) throw new Error('Response does not look like TLE data');
      try { sessionStorage.setItem(CACHE_KEY, JSON.stringify({ text, ts: Date.now() })); } catch (_) {}
      return text;
    } catch (e) {
      console.warn('Fetch attempt', i + 1, 'failed:', e.message);
      lastErr = e;
    }
  }
  throw lastErr;
}

// â”€â”€ Parse 3-line TLE text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTLE(rawText) {
  const chunks = rawText.replace(/\r/g, '')
    .split(/\n(?=[^12\s])/)
    .filter(c => c.trim());

  const now    = new Date();
  const parsed = [];

  for (const chunk of chunks) {
    const parts = chunk.split('\n').map(l => l.trim()).filter(Boolean);
    if (parts.length < 3) continue;
    const [nameLine, line1, line2] = parts;
    if (!line1.startsWith('1 ') || !line2.startsWith('2 ')) continue;

    try {
      const satrec = satellite.twoline2satrec(line1, line2);
      if (!satrec || satrec.error !== 0) continue;
      if (!satellite.propagate(satrec, now)?.position) continue;

      const yr2      = line1.substring(9, 11).trim();
      const launchNum = line1.substring(11, 14).trim();
      const year     = yr2 ? (parseInt(yr2) > 56 ? 1900 : 2000) + parseInt(yr2) : null;
      const launch   = year ? String(year) : 'â€”';
      const launchId = year && launchNum ? `${year}-${launchNum.padStart(3, '0')}` : 'â€”';

      parsed.push({ satrec, name: nameLine.replace(/^0 /, '').trim(), launch, launchId });
    } catch (_) {}
  }
  return parsed;
}

// â”€â”€ Load satellite data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSatelliteData() {
  setStatus('Connecting to CelesTrakâ€¦');
  setProgress(5);

  let rawText;
  try {
    rawText = await fetchWithCache();
  } catch (e) {
    setStatus('âš  Network error â€” please refresh to retry.');
    console.error('Could not load satellite data:', e);
    return;
  }

  setStatus('Parsing TLE dataâ€¦');
  setProgress(42);

  satData = parseTLE(rawText);
  console.log('Valid satellites:', satData.length);
  buildLaunchTable();

  setStatus('Loaded ' + satData.length.toLocaleString() + ' satellites');
  setProgress(72);
  initGlobe();
}

// â”€â”€ Globe initialisation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initGlobe() {
  setStatus('Initialising globeâ€¦');
  setProgress(84);

  updatePositions();

  globe = new Globe(document.getElementById('globe-container'))
    .globeImageUrl('//cdn.jsdelivr.net/npm/three-globe/example/img/earth-dark.jpg')
    .atmosphereColor('#8750ff')
    .backgroundColor('rgba(14,14,14,1)')
    .htmlElementsData(satData)
    .htmlLat('lat')
    .htmlLng('lng')
    .htmlAltitude('alt')
    .htmlElement(() => {
      const el = document.createElement('div');
      el.innerHTML = 'ğŸ›°ï¸';
      el.style.cssText = 'font-size:11px;line-height:1;user-select:none;pointer-events:none;';
      return el;
    });

  setTimeout(() => globe.pointOfView({ altitude: 3.5 }));

  countBadge.textContent = satData.length.toLocaleString() + ' satellites tracked';
  window.addEventListener('resize', () => globe.width(window.innerWidth).height(window.innerHeight));

  // Apply country borders + labels once data is ready (non-blocking)
  countryDataPromise.then(({ polygons, labels }) => {
    globe
      .polygonsData(polygons.features)
      .polygonCapColor(() => 'rgba(0,0,0,0)')
      .polygonSideColor(() => 'rgba(0,0,0,0)')
      .polygonStrokeColor(() => 'rgba(201,168,76,0.35)')
      .labelsData(labels)
      .labelLat('lat')
      .labelLng('lng')
      .labelText('text')
      .labelAltitude(0.01)
      .labelSize(0.6)
      .labelDotRadius(0)
      .labelColor(() => 'rgba(180,180,180,0.6)')
      .labelResolution(3);
  }).catch(e => console.warn('Country overlay failed:', e));

  setProgress(94);
  setStatus('Startingâ€¦');
  setTimeout(() => { setProgress(100); setTimeout(() => { dismissOverlay(); startAnimationLoop(); }, 300); }, 500);
}

// â”€â”€ Position update â€” mutates data objects in place â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePositions() {
  const now  = new Date();
  const gmst = satellite.gstime(now);
  satData.forEach(d => {
    const eci = satellite.propagate(d.satrec, now);
    if (eci?.position) {
      const geo = satellite.eciToGeodetic(eci.position, gmst);
      d.lat   = satellite.radiansToDegrees(geo.latitude);
      d.lng   = satellite.radiansToDegrees(geo.longitude);
      d.alt   = geo.height / EARTH_RADIUS_KM;
      d.altKm = Math.round(geo.height);
      const cls = classifyOrbit(geo.height);
      d.band  = cls.band;
      d.color = cls.color;
    } else {
      d.lat = NaN;
    }
  });
}

// â”€â”€ Animation loop â€” mutate positions; globe.gl re-reads each frame â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAnimationLoop() {
  (function frame() {
    requestAnimationFrame(frame);
    updatePositions();
  })();
}

loadSatelliteData();
</script>

</body>
</html>
